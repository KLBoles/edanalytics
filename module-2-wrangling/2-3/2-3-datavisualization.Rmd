---
title: "The Tidyverse: Tidying Data"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r load, include=FALSE}
library(learnr)
library(tidyverse)
library(ggthemes)
tutorial_options(exercise.timelimit = 60)
```

## Introduction

Welcome back to the Tidyverse! As noted before, in this module we will learn how to **transform** data, **tidy** data, and create **data visualizations** using the tidyverse package. 

Let's review the data science process figure once more (below). We have learned how to **import**, **tidy**, and **transform** our data as part of a process called **wrangling** because we are getting our data in a structure that we can work with in order to visualize and model our data.

```{r process, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/base.png"))

```

We have now reached the point where we can introduce you to data **visualization** which this final tutorial of this module will cover before moving onto the next module where we will learn how to model our data by using descriptive and basic inferential statistics.

As you can see, each of these processes build upon each other. We can't visualize our data without learning how to **import**, **tidy**, and **transform** our data first.

Now that we know where we've been and where we're headed, let's go ahead and jump into it!

## `ggplot2`

While there are several R packages to create visualizations, we will focus on the package `ggplot2` as it is one of the most versatile and intuitive visualization packages and is also part of the tidyverse. 

`ggplot2` works best using long data formats (which we learned in the previous tutorial). Additionally, `ggplot2` visualizations are built layer by layer by adding new elements and aesthetics as you go (more on this later). More specifically, `ggplot2` builds charts through layers using `geom_` functions. We've provided a few basic examples of these goeom charts below:

### `geom_point()`

```{r geompoint, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/geompoint.png"))

```

### `geom_bar`

```{r geombar, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/geombar.png"))

```

### `geom_histogram`

```{r geomhist, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/geomhist.png"))

```

### `geom_line`

```{r geomline, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/geomline.png"))

```

### Advanced Visualizations

While these are more basic and foundational data visualizations, ggplot2 can be used to create more advanced and highly aesthetic visualizations like the examples shown below.

```{r advancedcharts, echo=FALSE}
knitr::include_graphics(paste0(getwd(), "/images/advancedcharts.png"))

```

Now that you have a better sense of the types of charts that can be creating using ggplot2, let's go ahead and get started by learning how to create a `geom_point()` chart.

## `geom_point()`

The `geom_point()` function in ggplot2 creates scatterplots which show the relationship between 2 numeric variables by each point representing an observation. To illustrate this function, we're going to use a built-in R dataset called `iris`. This dataset contains measurements on 4 different attributes (in centimeters) for 50 iris flowers from 3 different species.

### Iris Dataset
```{r setup, include=FALSE}
data(iris)
data(ChickWeight)
```

```{r}
iris
```

Now that you have had a bit of practice exploring and digging into datasets, go ahead and use the lines below to start exploring your data. You can use `str()`, `head()`, `describe()` (in the `pysch` package), and other `dplyr` functions to get a better sense of the data before we start visualizing it.

### Explore the Data
```{r irisexplore, exercise=TRUE, exercise.lines = 15, exercise.setup = "setup"}

```

### Visualize the Data

Great! Let's go ahead and start visualizing the data. As noted previously, scatterplots are used to display the relationship between 2 numeric variables using a 2-dimensional plane (x and y axis). Looking at the Iris dataset, it would only be appropriate to examine the numeric variables in a scatterplot. You can change which variables you want to use, but for now we're going to examine the relationship between `Sepal.Length` and `Sepal.Width`.  

To create scatterplots using `geom_point()` we're going to have to provide the function with the name of a dataframe, specify which variables go on the x and y axis, and add `geom_point()` at the end to tell R we want a scatterplot of points.

```{r irisscatter, exercise=TRUE, exercise.setup = "setup"}
ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width)) + 
  geom_point()

```

Nice! Let's go ahead and walk through the code above. 

Step 1: When we want to create any visualization using `ggplot2`, we will want to start off using the function `ggplot()`. As a reminder, `ggplot2` is a package within the tidyverse and `ggplot()` is the function within the package.

Step 2: The first argument we provide the function is the name of the data object/dataframe. In this case, the name of our dataframe is `iris`.

Step 3: The second argument we provide the function is `aes` which is shorthand for aesthetic mappings. Aesthetic mapping describes how variables in the data (in our case, `iris`) are mapped to visual properties (aesthetics) of geoms. For our example, we want to specify the variable `Sepal.Length` to be mapped to the x axis and `Sepal.Width` to be mapped to the y axis. This needs to occur all within the `aes()` argument.

Step 4: Remember how we said that `ggplot2` visualizations are built layer by layer by adding new elements and aesthetics as you go? We've encountered the point where this happens! And this process of adding layers is demonstrated by the use of `+`. Previously, we learned about the pipe operator `|>` and how it tells R "do this and THEN do this" all through the use of `|>`. The `+` operator is similar in this sense but only works within the `ggplot2` framework. It tells R "do this then ADD this to what we've already done." This is why we have `+` at the end of the first line of code. In the first line of code, we tell R all the specifications we want. We identify the dataframe and we specify the aesthetics, but we haven't yet told R what type of visualization we want.

Step 5: In the final step, we tell R to do all the things specified in the first line of code and once that is built, then we want to add a new layer by telling R to display these specifications in a scatterplot. Hence, the `geom_point()` in the final line of code. 


### Aesthically Visualize the Data

The scatterplot above does a decent job at plotting the data to show the relationship between `Sepal.Length` and `Sepal.Width` but we can add some improvements. If you remember, the `iris` dataset also included the three different types of species. It would be more informative to view the relationship between `Sepal.Length` and `Sepal.Width` but also color-code each of these data points by `Species` to understand if there is more to the relationship between these two variables. 

We can accomplish this task by adding a layer!

#### Adding Color by `Species`

```{r irisscatter2, exercise=TRUE, exercise.setup = "setup"}
p <- ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width)) + 
  geom_point()

p + aes(color=Species)
```

Let's walk through the code above. Most of the code is the same as before with a few additions.

1. We assign our original chart to an object called `p`. 
2. In the next new line of code, we call the object `p` and then use the `+` operator to tell R to add a new aesthetic element and provide the data points colors based on the species they belong to as indicated by the variable `Species`. 

Note: As stated at the beginning of this course, there are numerous ways to produce the same outcome in R. We wanted to briefly highlight this note using the example we're working with. The two examples below produce the same output as the scatterplot we produced above, but are coded in different ways to accomplish this task. As a rule of thumb, you would want to use most succinct way produce the output you want. In the example above, we wanted to introduce an example of layering in `ggplot2` as soon as possible although the output can be produced with fewer lines of code.

**Example 1**

```{r, echo=FALSE}
ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width)) + 
  geom_point() +
  aes(color=Species)
```

**Example 2**

```{r, echo=FALSE}
ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point()
```

#### Changing the X and Y Axis Label + Title Label

Our scatterplot has already improved by adding color to demarcate the species types but we can further improve our chart. The x and y labels take the name of the variables assigned to these elements, but they do it verbatim. Let's go ahead and clean up these label names and add a title label by adding a layer.

```{r irisscatter3, exercise=TRUE, exercise.setup = "setup"}

ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point() + 
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)", 
       title = "Relationship Between Sepal Length and Width by Iris Species")
```

As you can see we add a layer by using the `+` operator, using the `labs()` function and then specifying the new x and y axis labels. This is looking better, but it looks like our title if off centered. Let's fix that!

```{r irisscatter4, exercise=TRUE, exercise.setup = "setup"}

ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point() + 
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)", 
       title = "Relationship Between Sepal Length and Width by Iris Species") +
  theme(plot.title = element_text(hjust = 0.5))

```

Nice! We were able to center the title of the chart by adding a new layer. The titles of `ggplot2` objects are automatically left-centered so we have to use the `theme()` function to adjust the positioning of the plot title by using this code `element_text(hjust = 0.5)`.

#### Specifying a Theme

This is looking great so far! Let's go ahead and further refine our scatterplot by specifying a theme. Before we do so, we want to note that `ggplot2` charts are produced using a standard theme, but we can change these plot themes to be more aesthetic. 

```{r irisscatter5, exercise=TRUE, exercise.setup = "setup"}

ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point() + 
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)", 
       title = "Relationship Between Sepal Length and Width by Iris Species") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()

```

This chart looks cleaner, less busy, and well... minimal (hence the theme name) compared to the previous iterations. This is a nice and clean look to use in presentations, papers, etc. 

#### More Themes!

We could dedicate a whole class to data visualization but we are aiming to keep this course as an introductory course. If you are interested in learning more about the different themes you can use in your data visualizations, you can explore the `ggthemes` package to use additional themes such as the visualization below.

```{r irisscatter6, exercise=TRUE, exercise.setup = "setup"}

ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point() + 
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)", 
       title = "Relationship Between Sepal Length and Width by Iris Species") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_stata() + 
  scale_color_stata()

```

#### Saving Plots

You will probably want to save your plots as a .png or .jpeg to use for papers or presentations and we can do this by using the `ggsave()` function. 

```{r ggsave, echo=FALSE}

p <- ggplot(iris, aes(x=Sepal.Length, y=Sepal.Width, color = Species)) + 
  geom_point() + 
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)", 
       title = "Relationship Between Sepal Length and Width by Iris Species") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_stata() + 
  scale_color_stata()

ggsave(filename = "iris-scatter.png")

```

The .png file will show up in your working directory or R project folder if you're using an R project.

## `geom_bar()`

Now that we have covered scatterplots using `geom_point()` we're going to learn how to make bar charts using `geom_bar`.

We do want to note that the layering aspects we covered in `geom_point()` apply to `geom_bar` and the other plots in `ggplot2` so we won't revisit those concepts here and will only focus on the aspects unique to `geom_bar()` and the remaining plots in this tutorial.

Great, let's get into it then!

As already noted, we can create bar charts using the `geom_bar()` function. Bar charts are used to illustrate the relationship between a numeric and a categorical variable.

Let's use the `iris` dataset to create a bar chart!

You can use the space below to explore the data if needed.

### Explore the Data
```{r irisexplore2, exercise=TRUE, exercise.lines = 15, exercise.setup = "setup"}
head(iris)
```

### Visualize the Data

Looking at the Iris dataset, we're going to use mean `Petal.Length` as our numeric variable and `Species` as our categorical variable (factor) to examine the relationship between these two variables.

In order to do use a `geom_bar()` to show the mean petal length of each of these species, we need to do a bit of data wrangling first!

To create bar charts using `geom_bar()` we're going to have to provide the function with the name of a dataframe, specify which variables go on the x and y axis, add `geom_bar()` at the end to tell R we want a bar chart, and within `geom_bar()` we want to set `stat` to `identity`.

```{r irisbar, exercise=TRUE, exercise.setup = "setup"}
iris |>
  group_by(Species) |> 
  summarise(Mean = mean(Petal.Length)) |>
  ggplot(aes(x=Species, y=Mean)) + 
  geom_bar(stat = "identity")

```

A note on `stat = "identity"`: The heights of bars commonly represent one of two items: 1) a count of cases in each group or 2) the values in a column of a data frame. By default, `geom_bar()` uses `stat = "bin"` which displays the number of cases in each group (which is not compatible with mapping values to the y aesthetic). Using `stat = "identity"` displays the value mapped to the y aesthetic (in this case the mean `Petal.Length`).

### Enhance the Visualization!

Let's go ahead and add a few things (some of which you're already familiar with and some you're not familiar with) to make this visualization even better!

```{r irisbar2, exercise=TRUE, exercise.setup = "setup"}
#wrangle data and create bar chart
p <- iris |>
  group_by(Species) |> 
  summarise(Mean = mean(Petal.Length)) |>
  ggplot(aes(x=Species, y=Mean)) + 
  geom_bar(stat = "identity")

#fix labels and add theme
p <- p + labs(y = "Mean Petal Length (cm)", 
       title = "Mean Petal Length by Iris Species") +
  theme_minimal()

#fix y scale
p <- p + scale_y_continuous(limits = c(0,6),breaks = seq(0,7,1))

#display mean values above bars
p <- p + geom_text(aes(label=Mean), position=position_dodge(width=0.2), vjust=-0.25)

p

```

Let's walk through some of the code above. We're already familiar with the first two blocks of codes so let's focus on the last two where we adjust the y axis scale and display the means above each of the bars.

Sometimes the scale for the x and y axis isn't quite what we want but we can change it! Since we have a continuous y scale, we can add a layer to our saved plot `p` and by specifying the lower and upper axis limits with `limits = c(0,6)` (0 for the lower limt and 6 for the upper limit) and by specifying the tick marks on the y axis with `breaks = seq(0,7,1)` (which tells R to make breaks in the scale from 0 to 7 with 1 unit increase in tick marks).

Great! But sometimes it might be helpful to display the actual numbers you want to show on a bar chart if it might be unclear to the reader. We can add the means of the petal lengths to each of the species bar by adding another layer using `geom_text()` which calls and displays the `Mean` value as specified in the first code block `ggplot(aes(x=Species, y=Mean))`. The `position=position_dodge(width=0.2), vjust=-0.25)` specifies the position of where on the plot the mean values should be displayed.

## `geom_histogram()`

Now that we have covered bar charts using `geom_bar()` we're going to learn how to make histograms using `geom_histogram`.

We do want to note that the layering aspects we covered in `geom_point()` and `geom_bar` apply to `geom_histogram` and the other plots in `ggplot2` so we won't revisit those concepts here and will only focus on the aspects unique to `geom_histogram()` and the remaining plots in this tutorial.

First, you might be wondering what the difference is between `geom_bar()` and `geom_histogram` which is a good curiosity to have. Bar charts (in general) are used to visually represent a categorical and numeric variable usually in counts, sums, means, or some single data point. Histograms are used to visually plot the density of numeric data such as the distributions of age or height for a sample or population.

In terms of code, there are only minor differences between the two: 1) use the `geom_histogram()` function and 2) only specifying one numeric variable.


We're going to use the `iris` dataset again to create a histogram.

You can use the space below to explore the data if needed.

### Explore the Data
```{r irisexplore3, exercise=TRUE, exercise.lines = 15, exercise.setup = "setup"}

```


### Visualize the Data

Looking at the Iris dataset, we're going to plot the density of the `Sepal.Width` for all species.

To create histograms using `geom_histogram()` we're going to have to provide the function with the name of a dataframe, specify which variables go on the x and y axis, add `geom_histogram()` at the end to tell R we want a histogram.

```{r irishist, exercise=TRUE, exercise.setup = "setup", exercise.lines = 10}
ggplot(iris, aes(x=Sepal.Width)) + 
  geom_histogram()

```

### Enhance the Visualization!

We've learned a few things in this tutorial so feel free to enhance the histogram above!

## `geom_line()`

Congratulations to making it to the final visualization we will learn about in this tutorial!

Line graphs are used to display the progression of two numeric variable through data points. These data points are usually connected by straight line segments. One of these numeric variables needs to be an ordered numeric variable to be placed on the X axis and the other needs to be a numeric variable to be placed on the Y axis. 

Given that the purpose of histograms is to view the trend of a numeric variable, the iris dataset lacks an ordered variable to display using a line graph. So we are going to use the `ChickWeight` dataset instead!

```{r}
ChickWeight
```

This dataset has data from an experiment which examined the effect of diet on early growth of checks. `weight` is the body weight of the chick measured in grams, `Time` is the number of days since birth when the body weight measurement was made, `Chick` is the unique identifier for the chick, and `Diet` is a factor variable which indicates which experimental diet the chick received. 

### Explore the Data
```{r chick1, exercise=TRUE, exercise.lines = 15, exercise.setup = "setup"}

```

### Visualize the Data

To create a line graph, we are going to plot the weight of Chick 1 over time using the `weight` and `Time` variables.

```{r chickline, exercise=TRUE, exercise.setup = "setup", exercise.lines = 10}
ChickWeight |>
  filter(Chick == 1) |>
  ggplot(aes(x=Time, y =weight)) + 
  geom_line()

```

Very neat! But what if we wanted to view all Chicks progression in weight over time? We can do that by specifying `group` and `color`. 

```{r chickline2, exercise=TRUE, exercise.setup = "setup", exercise.lines = 10}
ChickWeight |>
  ggplot(aes(x=Time, y =weight, group = Chick, color = Chick)) + 
  geom_line()

```

Here's a different visualization.

```{r chickline3, exercise=TRUE, exercise.setup = "setup", exercise.lines = 10}
ChickWeight |>
  ggplot(aes(x=Time, y =weight, group = Chick, color = Diet)) + 
  geom_line()

```

What do you notice about the second line graph and the third line graph produced? Is one better than the other? What adjustments would you make to improve the visualization?

### Enhance the Visualization!

We've learned a few things in this tutorial so feel free to enhance the line graph below!

```{r chickline4, exercise=TRUE, exercise.setup = "setup", exercise.lines = 10}


```

## Tasks

Now that you are more acquainted with data visualization in R, let's engage in a task! Please follow the steps outlined below. This task will be more open ended than the lasts where you will have more academic and creative freedom

1. Open the R script you created in the previous module (lastname-R-task4) that is saved in your project folder for this course. You should have code written to load the tidyverse and psych libraries and to read in your hsb dataset.Go ahead and run this script to make sure your code works (we are going to pick up where we left off last time).
2. You should be familiar with the hsb dataset now. Take some time to develop 2-3 research questions that can be answered using data visualization. Use at least 3 of the visualizations we learned in this tutorial to answer the questions you created.
3. Save your visualizations as .pngs
4. Post in the online Canvas discussion board titled XXXXX presenting your research questions as well as your visualizations your created (please attach visualizations to your post.)
5. Save R script as lastname-R-task5
7. Read the brief resource in Canvas titled: datavis-r-cheat-sheet.pdf

#### Note:
You may run into issues in completing the tasks listed above. Please refer to this document as well as the previous Learnr documents. Google is also a great resource when you run into issues in R.

### Reflect
Let's take some time to reflect before moving on. What is one thing that surprised you? What is one thing that confused you? Did you learn anything that might be useful in the type of work you do?

### El Fin
Good job on completing the final tutorial within the second module of this course! Please move onto the next and final module on Canvas where we will learn about descriptive statistics.